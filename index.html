<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>授受簿 電子化サンプル（固定ヘッダ・固定列）</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 16px;
    }
    h1 {
      margin-bottom: 8px;
    }
    #operator-section {
      margin-bottom: 16px;
    }

    /* スクロール領域を作るためのラッパ要素 */
    .table-wrapper {
      /* 縦も横もスクロールできるように */
      overflow: auto;
      /* 画面高さに応じて調整。例示で固定値にしています。 */
      max-height: 500px;
      border: 1px solid #ccc;
    }

    table {
      /* テーブルの最小幅を設定し、
         スマホなどで狭い場合は横スクロールで閲覧 */
      min-width: 1000px; 
      border-collapse: collapse;
      table-layout: auto;
      /* セル内改行を防止して横スクロールを発生させる */
      white-space: nowrap;
    }

    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
      vertical-align: middle;
    }

    /* stickyヘッダ */
    thead th {
      position: sticky;
      top: 0;
      background: #f0f0f0;
      z-index: 2; /* 背景と重なり制御を安定させるため */
    }

    /* 1列目（付託番号列）の固定 */
    /* ここでは「th:first-child, td:first-child」で指定 */
    th:first-child,
    td:first-child {
      position: sticky;
      left: 0;
      background: #f0f0f0; /* スクロール時の重なりを分かりやすくするため */
      z-index: 3; /* ヘッダより大きめにして重なりを回避 */
    }

    /* 完了行の色付けのみ。表示/非表示はJSで制御 */
    .completed {
      background-color: #e0ffe0;
    }

    .fill-operator-btn,
    .fill-date-btn {
      margin: 2px;
      cursor: pointer;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <h1>授受簿 電子化サンプル</h1>

  <!-- 操作者名入力欄 -->
  <div id="operator-section">
    操作者名：
    <input type="text" id="operatorName" placeholder="操作者名を入力" />
    <label>
      <input type="checkbox" id="showCompletedToggle" />
      完了項目を再表示
    </label>
  </div>

  <!-- テーブルスクロール領域 -->
  <div class="table-wrapper">
    <table id="recordTable">
      <thead>
        <tr>
          <th data-col="futakuNo">付託番号</th>
          <!-- a. グループ -->
          <th data-col="a_name">a. 記載者名</th>
          <th data-col="a_date">a. 月日</th>
          <!-- b. グループ -->
          <th data-col="b_name">b. 受け取り者名</th>
          <th data-col="b_date">b. 月日</th>
          <!-- c. グループ -->
          <th data-col="c_name">c. 返却者名</th>
          <th data-col="c_date">c. 月日</th>
          <!-- d. グループ -->
          <th data-col="d_name">d. 受け取り者名</th>
          <th data-col="d_date">d. 月日</th>
        </tr>
      </thead>
      <tbody>
        <!-- ここに自動的に行を追加 -->
      </tbody>
    </table>
  </div>

  <script>
    // -----------------------------
    // ユーティリティ
    // -----------------------------
    function getToday() {
      const now = new Date();
      const y = now.getFullYear();
      const m = String(now.getMonth() + 1).padStart(2, '0');
      const d = String(now.getDate()).padStart(2, '0');
      return `${y}-${m}-${d}`;
    }

    // テーブル要素取得
    const table = document.getElementById("recordTable");
    const tbody = table.querySelector("tbody");
    const operatorNameInput = document.getElementById("operatorName");
    const showCompletedToggle = document.getElementById("showCompletedToggle");

    // -----------------------------
    // 行を追加
    // -----------------------------
    function addNewRow() {
      const newRow = document.createElement("tr");

      // 付託番号セル
      const futakuCell = document.createElement("td");
      const futakuInput = document.createElement("input");
      futakuInput.type = "text";
      futakuInput.name = "futakuNo";
      futakuCell.appendChild(futakuInput);
      newRow.appendChild(futakuCell);

      // a. 記載者名 + 操作者名自動入力ボタン
      const aNameCell = document.createElement("td");
      const aNameInput = document.createElement("input");
      aNameInput.type = "text";
      aNameInput.name = "a_name";
      const aNameBtn = document.createElement("button");
      aNameBtn.textContent = "操作者名";
      aNameBtn.className = "fill-operator-btn";
      aNameBtn.onclick = () => {
        aNameInput.value = operatorNameInput.value;
        checkAndSaveRow(newRow);
      };
      aNameCell.appendChild(aNameInput);
      aNameCell.appendChild(aNameBtn);
      newRow.appendChild(aNameCell);

      // a. 月日 + 今日ボタン
      const aDateCell = document.createElement("td");
      const aDateInput = document.createElement("input");
      aDateInput.type = "date";
      aDateInput.name = "a_date";
      const aDateBtn = document.createElement("button");
      aDateBtn.textContent = "今日";
      aDateBtn.className = "fill-date-btn";
      aDateBtn.onclick = () => {
        aDateInput.value = getToday();
        checkAndSaveRow(newRow);
      };
      aDateCell.appendChild(aDateInput);
      aDateCell.appendChild(aDateBtn);
      newRow.appendChild(aDateCell);

      // b. 受け取り者名
      const bNameCell = document.createElement("td");
      const bNameInput = document.createElement("input");
      bNameInput.type = "text";
      bNameInput.name = "b_name";
      const bNameBtn = document.createElement("button");
      bNameBtn.textContent = "操作者名";
      bNameBtn.className = "fill-operator-btn";
      bNameBtn.onclick = () => {
        bNameInput.value = operatorNameInput.value;
        checkAndSaveRow(newRow);
      };
      bNameCell.appendChild(bNameInput);
      bNameCell.appendChild(bNameBtn);
      newRow.appendChild(bNameCell);

      // b. 月日
      const bDateCell = document.createElement("td");
      const bDateInput = document.createElement("input");
      bDateInput.type = "date";
      bDateInput.name = "b_date";
      const bDateBtn = document.createElement("button");
      bDateBtn.textContent = "今日";
      bDateBtn.className = "fill-date-btn";
      bDateBtn.onclick = () => {
        bDateInput.value = getToday();
        checkAndSaveRow(newRow);
      };
      bDateCell.appendChild(bDateInput);
      bDateCell.appendChild(bDateBtn);
      newRow.appendChild(bDateCell);

      // c. 返却者名
      const cNameCell = document.createElement("td");
      const cNameInput = document.createElement("input");
      cNameInput.type = "text";
      cNameInput.name = "c_name";
      const cNameBtn = document.createElement("button");
      cNameBtn.textContent = "操作者名";
      cNameBtn.className = "fill-operator-btn";
      cNameBtn.onclick = () => {
        cNameInput.value = operatorNameInput.value;
        checkAndSaveRow(newRow);
      };
      cNameCell.appendChild(cNameInput);
      cNameCell.appendChild(cNameBtn);
      newRow.appendChild(cNameCell);

      // c. 月日
      const cDateCell = document.createElement("td");
      const cDateInput = document.createElement("input");
      cDateInput.type = "date";
      cDateInput.name = "c_date";
      const cDateBtn = document.createElement("button");
      cDateBtn.textContent = "今日";
      cDateBtn.className = "fill-date-btn";
      cDateBtn.onclick = () => {
        cDateInput.value = getToday();
        checkAndSaveRow(newRow);
      };
      cDateCell.appendChild(cDateInput);
      cDateCell.appendChild(cDateBtn);
      newRow.appendChild(cDateCell);

      // d. 受け取り者名
      const dNameCell = document.createElement("td");
      const dNameInput = document.createElement("input");
      dNameInput.type = "text";
      dNameInput.name = "d_name";
      const dNameBtn = document.createElement("button");
      dNameBtn.textContent = "操作者名";
      dNameBtn.className = "fill-operator-btn";
      dNameBtn.onclick = () => {
        dNameInput.value = operatorNameInput.value;
        checkAndSaveRow(newRow);
      };
      dNameCell.appendChild(dNameInput);
      dNameCell.appendChild(dNameBtn);
      newRow.appendChild(dNameCell);

      // d. 月日
      const dDateCell = document.createElement("td");
      const dDateInput = document.createElement("input");
      dDateInput.type = "date";
      dDateInput.name = "d_date";
      const dDateBtn = document.createElement("button");
      dDateBtn.textContent = "今日";
      dDateBtn.className = "fill-date-btn";
      dDateBtn.onclick = () => {
        dDateInput.value = getToday();
        checkAndSaveRow(newRow);
      };
      dDateCell.appendChild(dDateInput);
      dDateCell.appendChild(dDateBtn);
      newRow.appendChild(dDateCell);

      // 入力変更イベント
      const inputs = [futakuInput, aNameInput, aDateInput, bNameInput, bDateInput,
                      cNameInput, cDateInput, dNameInput, dDateInput];
      inputs.forEach(input => {
        input.addEventListener("change", () => checkAndSaveRow(newRow));
      });

      tbody.appendChild(newRow);
      return newRow;
    }

    // -----------------------------
    // 行の状態をチェックして保存＋表示非表示
    // -----------------------------
    function checkAndSaveRow(row) {
      // 全ての input が埋まっていれば完了とみなす
      const inputs = row.querySelectorAll("input[type='text'], input[type='date']");
      let isComplete = true;
      inputs.forEach(i => {
        if (!i.value) {
          isComplete = false;
        }
      });

      const rowId = row.dataset.rowid;
      if (!rowId) return; // まだ行ID設定前の場合スキップ

      const savedData = JSON.parse(localStorage.getItem("flowData") || "{}");
      savedData[rowId] = { values: {}, completed: isComplete };

      inputs.forEach(i => {
        savedData[rowId].values[i.name] = i.value;
      });

      localStorage.setItem("flowData", JSON.stringify(savedData));

      if (isComplete) {
        row.classList.add("completed");
        if (!showCompletedToggle.checked) {
          row.style.display = "none";
        } else {
          row.style.display = "";
        }
      } else {
        row.classList.remove("completed");
        row.style.display = "";
      }

      addNewRowIfNeeded();
    }

    // 最下行が空なら追加
    function addNewRowIfNeeded() {
      const rows = tbody.querySelectorAll("tr");
      if (rows.length === 0) {
        const newRow = addNewRow();
        newRow.dataset.rowid = Date.now();
        return;
      }
      const lastRow = rows[rows.length - 1];
      const lastInputs = lastRow.querySelectorAll("input[type='text'], input[type='date']");
      let isAnyFilled = false;
      lastInputs.forEach(i => {
        if (i.value.trim() !== "") {
          isAnyFilled = true;
        }
      });
      if (isAnyFilled) {
        const newRow = addNewRow();
        newRow.dataset.rowid = Date.now();
      }
    }

    // -----------------------------
    // データ復元
    // -----------------------------
    function loadData() {
      const savedData = JSON.parse(localStorage.getItem("flowData") || "{}");
      Object.keys(savedData).forEach(rowId => {
        const info = savedData[rowId];
        const newRow = addNewRow();
        newRow.dataset.rowid = rowId;
        const inputs = newRow.querySelectorAll("input[type='text'], input[type='date']");
        inputs.forEach(i => {
          if (info.values[i.name]) {
            i.value = info.values[i.name];
          }
        });
        if (info.completed) {
          newRow.classList.add("completed");
          if (!showCompletedToggle.checked) {
            newRow.style.display = "none";
          }
        }
      });
    }

    // -----------------------------
    // ヘッダクリックによるソート
    // -----------------------------
    let currentSortCol = null;
    let currentSortDir = 1; // 1: 昇順, -1: 降順

    function sortTable(colName) {
      const rowsArray = Array.from(tbody.querySelectorAll("tr"));
      rowsArray.sort((rowA, rowB) => {
        const aValue = getCellValue(rowA, colName);
        const bValue = getCellValue(rowB, colName);
        if (aValue < bValue) return -1 * currentSortDir;
        if (aValue > bValue) return 1 * currentSortDir;
        return 0;
      });
      rowsArray.forEach(row => tbody.appendChild(row));
    }

    function getCellValue(row, colName) {
      const indexMap = {
        futakuNo: 0, a_name: 1, a_date: 2, b_name: 3, b_date: 4,
        c_name: 5, c_date: 6, d_name: 7, d_date: 8
      };
      const index = indexMap[colName];
      if (index == null) return "";
      const cell = row.cells[index];
      const input = cell.querySelector("input");
      return input ? input.value : "";
    }

    const headers = table.querySelectorAll("thead th");
    headers.forEach(th => {
      th.addEventListener("click", () => {
        const colName = th.dataset.col;
        if (colName === currentSortCol) {
          currentSortDir *= -1;
        } else {
          currentSortCol = colName;
          currentSortDir = 1;
        }
        sortTable(colName);
      });
    });

    // -----------------------------
    // チェックボックスイベント
    // -----------------------------
    showCompletedToggle.addEventListener("change", () => {
      const rows = tbody.querySelectorAll("tr");
      rows.forEach(row => {
        if (row.classList.contains("completed")) {
          row.style.display = showCompletedToggle.checked ? "" : "none";
        }
      });
    });

    // -----------------------------
    // 初期化
    // -----------------------------
    loadData();
    addNewRowIfNeeded();
  </script>
</body>
</html>
